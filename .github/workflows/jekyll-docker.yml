name: HTML Project Deployment & Preview
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (if any)
        run: |
          if [ -f "package.json" ]; then
            npm ci
          else
            echo "No package.json found, skipping npm install"
          fi

      - name: Validate HTML
        run: |
          # Check if index.html exists
          if [ -f "index.html" ]; then
            echo "âœ… Found index.html"
            # Simple HTML validation - check for basic structure
            if grep -q "<!DOCTYPE html>" index.html && grep -q "<html" index.html; then
              echo "âœ… HTML structure looks good"
            else
              echo "âš ï¸  Warning: Basic HTML structure might be missing"
            fi
          else
            echo "âŒ No index.html found in root directory"
            exit 1
          fi

      - name: Check HTML file
        run: |
          # Check file size
          if [ -f "index.html" ]; then
            FILESIZE=$(stat -c%s "index.html")
            echo "ğŸ“„ index.html file size: $FILESIZE bytes"

            # Check for common HTML issues
            echo "ğŸ” Checking HTML structure..."

            # Check for required tags
            REQUIRED_TAGS=("<!DOCTYPE html>" "<html" "<head>" "<body>")
            for tag in "${REQUIRED_TAGS[@]}"; do
              if grep -q "$tag" index.html; then
                echo "âœ… Found: $tag"
              else
                echo "âš ï¸  Missing: $tag"
              fi
            done

            # Count elements
            echo "ğŸ“Š Element counts:"
            echo "  <div> tags: $(grep -c "<div" index.html || echo 0)"
            echo "  <p> tags: $(grep -c "<p>" index.html || echo 0)"
            echo "  <img> tags: $(grep -c "<img" index.html || echo 0)"
            echo "  <video> tags: $(grep -c "<video" index.html || echo 0)"
          fi

      - name: Build status
        run: |
          echo "ğŸ‰ HTML project build and validation completed successfully!"
          echo "Project structure:"
          ls -la

  preview:
    runs-on: ubuntu-latest
    needs: build-and-test  # ä¾èµ–buildä»»åŠ¡æˆåŠŸ
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'  # åªåœ¨PRæˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
    steps:
      - uses: actions/checkout@v4

      - name: Start HTTP server
        run: |
          echo "ğŸš€ Starting HTTP server on port 8080..."
          # ä½¿ç”¨Pythonå¯åŠ¨ç®€å•çš„HTTPæœåŠ¡å™¨
          python3 -m http.server 8080 &
          SERVER_PID=$!
          echo "HTTP server started with PID: $SERVER_PID"

          # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
          sleep 2

          # æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
          if curl -s http://localhost:8080/ > /dev/null; then
            echo "âœ… HTTP server is running"
          else
            echo "âŒ HTTP server failed to start"
            exit 1
          fi

          # ä¿å­˜PIDä¾›åç»­ä½¿ç”¨
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

      - name: Setup ngrok for public access
        run: |
          echo "ğŸŒ Setting up ngrok for public access..."

          # ä¸‹è½½ngrok
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok-v3-stable-linux-amd64.tgz
          chmod +x ngrok

          # è®¾ç½®ngrokè®¤è¯ä»¤ç‰Œï¼ˆéœ€è¦å…ˆåœ¨GitHubä»“åº“è®¾ç½®secrets.NGROK_AUTH_TOKENï¼‰
          if [ -n "${{ secrets.NGROK_AUTH_TOKEN }}" ]; then
            ./ngrok config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
            echo "âœ… ngrok authtoken configured"
          else
            echo "âš ï¸  No NGROK_AUTH_TOKEN secret found. Using anonymous ngrok (limited)"
          fi

          # å¯åŠ¨ngrokéš§é“
          echo "ğŸ”— Starting ngrok tunnel..."
          ./ngrok http 8080 --log=stdout > ngrok.log &
          NGROK_PID=$!
          echo "NGROK_PID=$NGROK_PID" >> $GITHUB_ENV

          # ç­‰å¾…ngrokå¯åŠ¨
          sleep 5

          # è·å–å…¬ç½‘URL
          PUBLIC_URL=$(grep -o 'https://[0-9a-z]*\.ngrok-free\.app' ngrok.log | head -1 || true)
          if [ -n "$PUBLIC_URL" ]; then
            echo "ğŸŒ Public URL: $PUBLIC_URL"
            echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV

            # åœ¨PRè¯„è®ºä¸­æ·»åŠ é¢„è§ˆé“¾æ¥ï¼ˆå¦‚æœæ˜¯PRï¼‰
            if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
              echo "Adding preview URL to PR..."
              # è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨è¯„è®ºPRçš„é€»è¾‘
            fi
          else
            echo "âŒ Failed to get public URL from ngrok"
            cat ngrok.log
          fi

      - name: Keep preview running
        run: |
          echo "â° Keeping preview running for 30 minutes..."
          echo "Public URL: $PUBLIC_URL"
          echo "You can access your HTML project at: $PUBLIC_URL"
          echo ""
          echo "To stop the preview, cancel this workflow run."
          echo ""
          echo "Server will automatically stop after 30 minutes or when workflow is cancelled."

          # è¿è¡Œ30åˆ†é’Ÿï¼ˆ1800ç§’ï¼‰
          for i in {1..180}; do
            echo "â³ Running for $(($i * 10)) seconds..."
            sleep 10
          done

          echo "ğŸ•’ 30 minutes elapsed, stopping preview..."

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."

          # åœæ­¢ngrok
          if [ -n "$NGROK_PID" ]; then
            echo "Stopping ngrok (PID: $NGROK_PID)..."
            kill $NGROK_PID 2>/dev/null || true
          fi

          # åœæ­¢HTTPæœåŠ¡å™¨
          if [ -n "$SERVER_PID" ]; then
            echo "Stopping HTTP server (PID: $SERVER_PID)..."
            kill $SERVER_PID 2>/dev/null || true
          fi

          echo "âœ… Cleanup completed"
